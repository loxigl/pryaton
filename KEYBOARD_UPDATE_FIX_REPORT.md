# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å. –í –ª–æ–≥–∞—Ö –±—ã–ª–æ –≤–∏–¥–Ω–æ:
- ‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å: `"–ò–≥—Ä–∞ 13 –∑–∞–ø—É—â–µ–Ω–∞ - —Ñ–∞–∑–∞ –ø—Ä—è—Ç–æ–∫ –Ω–∞—á–∞–ª–∞—Å—å (auto)"`
- ‚úÖ –†–æ–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–ª–∏—Å—å: `"–†–æ–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –¥–ª—è –∏–≥—Ä—ã 13: 2 –≤–æ–¥–∏—Ç–µ–ª–µ–π, 1 –∏—Å–∫–∞—Ç–µ–ª–µ–π"`
- ‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: `"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä –¥–ª—è 3 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã 13"`
- ‚ùå **–ù–û –ù–ï–¢ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è**: `"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä X –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"`

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
1. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –≤—ã–∑–æ–≤–æ–≤**: –ö–æ–¥ –ª–æ–≥–∏–∫–∏ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
   - `enhanced_scheduler_service.start_game()` ‚Üí `GameService._start_game_internal()` ‚Üí `KeyboardUpdateService.schedule_keyboard_updates_for_game()`

2. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ**: –û—Å–Ω–æ–≤–Ω–∞—è –æ—à–∏–±–∫–∞ –±—ã–ª–∞ –≤ `KeyboardUpdateService.schedule_keyboard_updates_for_game()`
   ```python
   # –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–∑–¥–∞–Ω–∏–µ async task –≤ sync –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
   asyncio.create_task(KeyboardUpdateService._send_keyboard_updates(user_ids))
   ```
   –ú–µ—Ç–æ–¥ `schedule_keyboard_updates_for_game` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞, –Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É —Å –ø–æ–º–æ—â—å—é `asyncio.create_task()`.

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ event loop**: `asyncio.create_task()` —Ç—Ä–µ–±—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ event loop, –Ω–æ –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–ª—Å—è –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–µ–∑ loop.

## –†–µ—à–µ–Ω–∏–µ
–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–ª `KeyboardUpdateService` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ APScheduler:

### 1. –ò–∑–º–µ–Ω–µ–Ω –º–µ—Ç–æ–¥ `schedule_keyboard_updates_for_game`
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
scheduler = get_enhanced_scheduler()
if scheduler and scheduler.bot:
    # –ü–ª–∞–Ω–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    run_time = datetime.now() + timedelta(seconds=1)
    
    scheduler.scheduler.add_job(
        KeyboardUpdateService._send_keyboard_updates_sync,
        trigger='date',
        run_date=run_time,
        args=[user_ids, scheduler.bot],
        id=f"keyboard_update_{game_id}_{int(run_time.timestamp())}",
        replace_existing=True
    )
```

### 2. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `_send_keyboard_updates_sync`
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ APScheduler
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `bot` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä (–Ω–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä)

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å traceback
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### `src/services/keyboard_update_service.py`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ APScheduler –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∏–º–ø–æ—Ä—Ç–∞ TOKEN –∏–∑ main.py
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–æ—Ç–∞ –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

### `src/services/game_service.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `_start_game_internal`
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–∞ KeyboardUpdateService

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
1. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç**: –ó–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ event loop –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ APScheduler
3. **–û—Ç–ª–∞–¥–æ—á–Ω–æ—Å—Ç—å**: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
4. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å API

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:
```
üîÑ –ù–∞—á–∏–Ω–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä –¥–ª—è –∏–≥—Ä—ã 13
–ù–∞–π–¥–µ–Ω–æ 3 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –∏–≥—Ä–µ 13
–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ 3 telegram_id –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä: [1330908686, 573871744, ...]
–ü–ª–∞–Ω–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä —á–µ—Ä–µ–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä –¥–ª—è 3 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã 13 –Ω–∞ 2025-01-21 18:30:01
üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä –¥–ª—è 3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä 3/3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
```

–ò —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏:
- –î–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π: `üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é`, `üì∏ –§–æ—Ç–æ –º–µ—Å—Ç–∞`, `üöó –ú–µ–Ω—è –Ω–∞—à–ª–∏`
- –î–ª—è –∏—Å–∫–∞—Ç–µ–ª–µ–π: `üìç –ú–æ—è –ø–æ–∑–∏—Ü–∏—è`, `üì∏ –§–æ—Ç–æ –Ω–∞—Ö–æ–¥–∫–∏`, `üîç –Ø –Ω–∞—à–µ–ª –≤–æ–¥–∏—Ç–µ–ª—è`

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
21 —è–Ω–≤–∞—Ä—è 2025 –≥. 