# Telegram Bot PRYTON

Telegram-бот для проекта PRYTON, предназначенный для организации и проведения игр с поиском спрятавшегося игрока.

## Функциональные возможности

- Регистрация участников с сохранением информации о пользователе
- Создание и запись на игры с ограничением по количеству участников
- Автоматическое распределение ролей между игроками
- Геотрекинг участников во время игры
- Таймеры для отсчета до начала игры и времени на прятки
- Функция фотофиксации игроков
- Администраторская панель для управления играми
- Система уведомлений и напоминаний

## Технический стек

- Python 3.10+
- python-telegram-bot
- PostgreSQL
- SQLAlchemy
- Docker
- Alembic (миграции)
- APScheduler (планировщик задач)

## Запуск проекта

### Используя Docker (рекомендуется)

1. Клонируйте репозиторий и перейдите в директорию проекта:

```bash
git clone https://github.com/yourusername/pryton-bot.git
cd pryton-bot
```

2. Запустите скрипт запуска:

```bash
./start.sh
```

Скрипт автоматически создаст файл `.env` (если он не существует), проверит его настройки и запустит контейнеры Docker.

3. Отредактируйте файл `.env` и укажите токен вашего Telegram-бота.

4. Чтобы остановить бота, используйте:

```bash
./stop.sh
```

### Локальная разработка

1. Создайте виртуальное окружение и активируйте его:

```bash
python -m venv venv
source venv/bin/activate  # На Linux/Mac
venv\Scripts\activate  # На Windows
```

2. Установите зависимости:

```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` с необходимыми переменными

4. Запустите миграции для создания структуры БД:

```bash
alembic upgrade head
```

5. Запустите бота:

```bash
python main.py
```

## Управление миграциями базы данных

Для управления миграциями базы данных используется скрипт `migration.sh`:

```bash
# Инициализация директории миграций (если ещё не инициализирована)
./migration.sh init

# Создание новой ревизии на основе изменений в моделях
./migration.sh revision "описание изменений"

# Применение всех миграций
./migration.sh upgrade

# Откат последней миграции
./migration.sh downgrade

# Просмотр истории миграций
./migration.sh history

# Для получения полной справки
./migration.sh help
```

## Структура проекта

```
/tg_bot
  /src
    /handlers          # обработчики команд
    /keyboards         # клавиатуры
    /middlewares       # промежуточные обработчики
    /models            # модели данных
    /services          # бизнес-логика
    /utils             # вспомогательные функции
  /alembic             # миграции БД
  /logs                # логи приложения
  /tests               # тесты
  .env                 # переменные окружения
  .gitignore
  requirements.txt
  main.py              # точка входа
  start.sh             # скрипт запуска в Docker
  stop.sh              # скрипт остановки в Docker
  migration.sh         # скрипт управления миграциями
  Dockerfile           # файл для сборки Docker-образа
  docker-compose.yml   # конфигурация Docker Compose
```

## Мониторинг и метрики

Для отслеживания состояния бота используется связка **Prometheus**, **Alertmanager** и **Grafana**.

1. Бот экспортирует метрики на порт, заданный переменной `METRICS_PORT` (по умолчанию `8000`).
2. Prometheus собирает эти данные и отправляет алерты в Alertmanager.
3. Grafana подключается к Prometheus для визуализации статистики.

После запуска `./start.sh` сервисы будут доступны на портах:

- `9090` - интерфейс Prometheus
- `9093` - интерфейс Alertmanager
- `3000` - Grafana (логин/пароль по умолчанию `admin`/`admin`).


## Разработка

Проект организован в соответствии с принципами чистой архитектуры:

- `handlers` - обработчики команд пользователя
- `models` - модели данных для работы с БД
- `services` - бизнес-логика приложения
- `utils` - вспомогательные функции

## Лицензия

MIT 